---
id: tap-fun-paysdk
title: 付费购买
sidebar_label: 付费购买
---

import {Gray,Blue, Red, Black,Link,ImageLink} from '../component';


## 付费认证

<Gray>为了游戏售卖服务的功能，避免 APK 流出导致盗版横行；当游戏准备在 TapTap 开放售卖时，可以接入此功能。</Gray>

需要引入license库，`using TapTap.License;`

### 1. 设置授权回调

```cs
//默认情况下 SDK 会弹出不可由玩家手动取消的弹窗来避免未授权玩家进入游戏，如果需要回调来触发流程，请添加如下代码
TapLicense.SetLicencesCallback(ITapLicenseCallback callback);

public interface ITapLicenseCallback
{
    // 授权成功回调
    void OnLicenseSuccess();
}

```

### 2. 检查付费授权

```cs
TapLicense.Check();
```

## DLC 查询和购买

### 1. DLC 回调设置

```cs
public class MyTapDLCCallback:ITapDlcCallback
{
    public void OnQueryCallBack(TapLicenseQueryCode code, Dictionary<string, object> queryList)
    {
        
    }

    public void OnOrderCallBack(string sku, TapLicensePurchasedCode status)
    {
        
    }
}

TapLicense.SetDLCCallback(new MyTapDLCCallback());

```

### 2. DLC 查询

```cs
TapLicense.QueryDLC(string[] skuIds);
```


### 3. DLC 购买

```cs
TapLicense.PurchaseDLC(string skuId);
```

### 参数说明
#### TapLicenseQueryCode
回调          | 回调值 | 说明       |
----------- | --- | -------- |
QUERY_RESULT_OK       | 0   | 动态发布成功     |
QUERY_RESULT_NOT_INSTALL_TAPTAP       | 1   | 动态发布成功     |
QUERY_RESULT_ERR       | 2   | 动态发布成功     |
ERROR_CODE_UNDEFINED       | 80000   | 动态发布成功     |


#### skuId:
内购商品id，需要在admin后台配置

## 测试

为了保证上线后，游戏对于用户是否购买的判断能够正常生效，**请务必按照以下说明完成自测。**

### **1. 上传APK**

上传需要测试的APK至开发者中心，并通过审核。

### **2. 配置SDK**

前往开发者中心   >>   选择<Blue>SDK控制台 </Blue>   >>   选择<Blue>购买激活SDK</Blue>   >>   选择相应的游戏的<Blue>配置</Blue>   >>   填写测试用户的 TapTap ID 。

或者，前往开发者中心   >>   选择已经开放售卖的游戏 >>   选择<Blue>购买激活SDK设置</Blue>   >>   填写测试用户的 TapTap ID 。

### **3. 开始测试**

在 TapTap 客户端使用已填写的测试用户账号登录。

## 正式开始售卖

### **1. 完善应用信息**

前往开发者中心，按照[物料要求](/store/7-物料要求.md)填写应用信息，并审核通过。

### **2. 设置售卖价格**

前往开发者中心 >> <Blue>售卖设置</Blue> ，开启售卖开关，设置游戏售卖金额，提交审核，并同步对接的 TapTap 运营相关信息。

### **3. 正式上线**

所有流程都确保顺利后，游戏可[正式上线](https://www.taptap.com/developer/help_docs/7?id=47)。
![用来空行的小白条](https://img.tapimg.com/market/images/c53d78b9b120276b53f82aebb0d01537.png)

---

## 常见问题

### **1.关于Android 11 无法拉起TapTap 客户端的解决方案** ###

Android 11 加强了隐私保护策略，引入了大量变更和限制，其中一个重要变更 —— [软件包可见性](https://developer.android.com/about/versions/11/privacy/package-visibility) ，将会导致第三方应用无法拉起 TapTap 客户端，从而影响TapTap 相关功能的正常使用 ，包括但不限于更新唤起 TapTap 、购买验证等功能。
特别需要注意的是，Android 11 的该变更只会影响到升级` targetSdkVersion=30 `的应用，未升级的应用暂不受影响。

**方案一：**

编译时将` targetSdkVersion` 改为29（目前=30会触发该问题）

**方案二：**

1. 将gradle build tools 改为4.1.0+
```java
classpath 'com.android.tools.build:gradle:4.1.0'
```

2. 在AndroidManifest.xml 里添加如下内容
```xml
<queries>
    <package android:name="com.taptap" />
    <package android:name="com.taptap.pad" />
    <package android:name="com.taptap.global" />
  </queries>
```

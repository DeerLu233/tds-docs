---
id: cloud-engine
title: 云引擎开发指南
sidebar_label: 部署应用
---

import MultiLang from '/src/docComponents/MultiLang';
import QuickStartInit from './_partials/quick-start-init.mdx';
import QuickStartDeploy from './_partials/quick-start-deploy.mdx';

云引擎是一个托管后端程序的平台，开发者可以将 Web 应用（例如一个网站），或者 Node.js、Python、Java、PHP、.Net、Go 等语言的后端程序（例如一个 RESTful API 服务器）部署到运行上，云引擎会自动从源代码构建出可运行的「版本」，然后将它运行在独立的容器中，同时提供日志和监控、负载均衡、平滑发布、弹性扩容等能力。此外，云引擎还提供了定时任务、域名和证书管理和 Redis、MySQL、MongoDB、Elasticsearch 等多种托管数据库供开发者使用。

这篇文档会帮助你快速地部署第一个云引擎应用、了解云引擎平台提供的功能，有关具体运行环境的详情请查看专门的文档页面：

- [Web 应用运行环境]
- [Node.js 运行环境]
- [Python 运行环境]
- [Java 运行环境]
- [PHP 运行环境]
- [.Net (C#) 运行环境]
- [Go 运行环境]

## 快速开始

:::tip
如果仅希望使用云函数和 Hook 而不是部署通用的后端程序，建议查看 [云函数开发指南] 中的「快速开始」。
:::

### 创建项目

<QuickStartInit />

### 本地运行和调试

在确保所有的依赖都正确安装之后，就可以在项目根目录用我们的命令行工具来启动本地调试了：

```sh
tds up
```

更多有关命令行工具和本地调试的内容请看[云引擎命令行工具使用指南](/sdk/engine/guide/cli/)。

### 部署到云引擎

<QuickStartDeploy />

你可以在控制台绑定云引擎域名，绑定域名后，即可通过绑定域名访问你的应用。例如你在控制台绑定了 `web.example.com` 这个域名，即可通过 `https://web.example.com` 访问你的应用（生产环境）。

## 使用数据存储服务

在云引擎中你可以使用云服务提供的数据存储作为应用的后端数据库，以及使用其他云服务提供的功能。
SDK 可以让你更加方便地使用这些功能。

建议使用云引擎模板项目。
模板项目已经集成了 SDK，也包含了初始化 SDK 的逻辑，可以直接使用。

建议在客户端（浏览器端、移动端）登录用户，调用 SDK 的接口获取 session token。
对于需要后端以当前用户的身份完成的操作，客户端通过 HTTP Header 等方式将 session token 发送给后端。

参见[数据存储指南](/sdk/storage/guide/dotnet/)。

## 健康监测

你的应用在启动时，云引擎的管理程序会每秒去检查你的应用是否启动成功，如果超过启动时间限制仍未启动成功，即认为启动失败。
在之后应用正常运行的过程中，也会有定期的「健康监测」，以确保你的应用正常运行，如果健康监测失败，云引擎管理程序会自动重启你的应用。

健康检查的 URL 包括你的应用首页（`/`）和 SDK 负责处理的 `/__engine/1/ping`，只要 **两者之一** 返回了 HTTP `200` 的响应，就视作成功。
因此请确保你的应用使用了 SDK，或你的应用 **首页能够正常地返回 HTTP `200`** 响应。

## 查看日志和资源统计

## 调整实例规格和数量

## 部署与发布

### 命令行部署

在你的项目根目录运行：

```sh
tds deploy
```

即可部署至预备环境。
之后运行 `tds publish` 可以将预备环境的代码发布到生产环境。
注意，免费版只有一个环境，`tds deploy` 会直接部署到生产环境。

使用命令行工具可以非常方便地部署、发布应用，查看应用状态，查看日志，甚至支持多应用部署。
具体使用请参考《命令行工具指南》。

### Git 部署

除此之外，还可以使用 git 仓库部署。你需要将项目提交到一个 git 仓库，我们并不提供源码的版本管理功能，而是借助于 git 这个优秀的分布式版本管理工具。我们推荐你使用 [GitHub](https://github.com/)、[Coding](https://coding.net/) 或者 [码云](https://gitee.com/) 这样第三方的源码托管网站，也可以使用你自己搭建的 git 仓库（比如 [GitLab](https://about.gitlab.com/)）。

你需要先在这些平台上创建一个项目（如果已有代码，请不需要选择「Initialize this repository with a README」），在网站的个人设置中填写本地机器的 SSH 公钥（以 GitHub 为例，在 **Settings** > **SSH and GPG keys** 中点击 **New SSH key**），然后在项目目录执行：

```sh
git remote add origin git@github.com:<username>/<repoName>.git
git push -u origin master
```

然后到云引擎的设置界面填写你的 Git 仓库地址，如果是公开仓库建议填写 HTTPS 地址，例如 `https://github.com/<username>/<repoName>.git`。

如果是私有仓库需要填写 SSH 地址（<code>git&commat;github.com:&lt;username&gt;/&lt;repoName&gt;.git</code>），还需要你将云引擎分配给你的公钥填写到第三方托管平台的 Deploy keys 中，以 GitHub 为例，在项目的 **Settings** > **Deploy keys** 中点击 **Add deploy key**。

设置好之后，今后需要部署代码时就可以在云引擎的部署界面直接点击「部署」了，默认会部署 `master` 分支的代码，你也可以在部署时填写分支、标签或具体的 Commit。
如果仓库使用了 submodule，云引擎也会自动拉取 submodule。

如果希望 push 到项目的 Git 仓库的特定分支后自动触发云引擎部署，可以在应用的 **开发者中心 > 你的游戏 > 游戏服务 > 云服务 > 云引擎 > 云引擎分组 > 部署 > Git 部署 > 自动部署** 查看 deploy token 和 webhook 地址。
控制台显示的 deploy token 可以用来构造 HTTP 请求触发部署。
在控制台填写项目仓库的分支名称，并选择云引擎的运行环境后，控制台会生成相应的 webhook 地址。
该地址收到任意 POST 请求后，会部署指定分支的代码到指定的运行环境。

例如，在 GitHub 代码仓库的 **Settings** > **Webhooks** > **Payload URL** 填写生成的 webhook 后（其他选项均使用默认值，不用修改），下次 push 到项目仓库的 **任意** 分支，云引擎会自动根据 **指定** 分支更新代码，重新部署。之所以 push 到任意分支都会触发重新部署，是因为 GitHub 的 webhook 触发事件设置粒度较粗，不能指定仅在 push 到特定分支时触发 webhook。另一方面，云引擎也没有适配具体的托管平台，不会根据 GitHub 提交的 POST 内容中的分支信息决定是否重新部署。
不过，你可以使用 GitHub Action 更精细地控制部署时机，具体可以参考控制台显示的示例。

### 预备环境和生产环境

默认情况，云引擎只有一个「生产环境」。在生产环境中有一个「体验实例」来运行应用。

当生产环境的体验实例升级到「标准实例」后会有一个额外的「预备环境」。两个环境所访问的都是同样的数据，你可以用预备环境测试你的云引擎代码，每次修改先部署到预备环境，测试通过后再发布到生产环境；如果你希望有一个独立数据源的测试环境，建议单独创建一个应用。

在云引擎托管的网站需要绑定域名才能访问。
以 `stg-` 开头的域名会自动绑定到预备环境。

如果访问云引擎遇到「Application not Found」的错误，通常是因为对应的环境还没有部署代码。例如应用可能没有预备环境，或应用尚未发布代码到生产环境。

有些时候你可能需要知道当前云引擎运行在什么环境（开发环境、预备环境或生产环境），从而做不同的处理。
Node.js 项目可以通过检查环境变量 `NODE_ENV` 的值来判断：值为 `development` 意味着当前环境为「开发环境」，是由命令行工具启动的；值为 `production` 意味着当前环境为「生产环境」，是线上正式运行的环境；值为 `staging` 意味着当前环境为「预备环境」。
其他语言的项目可以通过检查环境变量 `LEANCLOUD_APP_ENV` 的值来判断：值为 `development` 意味着当前环境为「开发环境」，是由命令行工具启动的；值为 `production` 意味着当前环境为「生产环境」，是线上正式运行的环境；值为 `stage` 意味着当前环境为「预备环境」。

### 部署历史

在**开发者中心 > 你的游戏 > 游戏服务 > 云服务 > 云引擎 > 云引擎分组 > 部署**页面可以分别查看预备环境和生产环境的历史部署。
每个历史部署版本会显示简短描述（基于 git 提交日志等信息）、部署版本号、部署时间。
历史部署按部署时间倒序排列，当前部署排在最前。
点击**回滚至该版本**按钮，可以回滚至相应的部署版本。
点击**查看更多历史部署**可以查看最近部署的 10 个版本。
除了按预备环境和生产环境分别查看历史部署外，点击右上角的**查看部署时间线**则可以按照时间顺序（最新部署在前）查看部署到云引擎的各个版本。

除了查看部署历史外，这里还会显示预备环境或生产环境的部署状态（「休眠中」、「部署中」、「运行中」）。
通过右上角的按钮还可以**重启**（重新部署当前版本）或**清除部署**（移除部署，注销相应的云函数和 Hook）。
预备环境还可以点击右上角的**部署到生产环境**按钮将最近部署到预备环境的版本发布到生产环境。
当部署状态为「部署中」时，控制台会显示部署进行中的一些信息，也会显示一个**取消部署**按钮，点击可以取消部署。

### 日志

在 **开发者中心 > 你的游戏 > 游戏服务 > 云服务 > 云引擎 > 云引擎分组 > 日志** 中可以查看云引擎的部署和运行日志，还可以通过环境（预备环境、生产环境）、类型（标准输出、标准错误）、实例、日期时间进行筛选。

你还可以通过命令行工具来导出最近七天的日志到本地文件，方便进行进一步的分析和统计。

应用的日志可以直接输出到「标准输出」或者「标准错误」，这些信息会分别对应日志的 `info` 和 `error` 级别。

云引擎的访问日志（Access Log）也可以在控制台导出（**开发者中心 > 你的游戏 > 游戏服务 > 云服务 > 云引擎 > 访问日志**）。
